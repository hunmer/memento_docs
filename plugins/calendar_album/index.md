# Calendar Album - 日历相册插件

<PluginSwiper plugin-name="calendar_album" />

📓 **Calendar Album 日历相册** - 基于日历的日记管理，支持 Markdown 编辑和图片相册

## 核心功能

### 📅 日历日记管理
- **日历视图**：在日历上直接查看和创建日记条目
- **日期标记**：在日历上标记有日记的日期，显示条目数量
- **快速导航**：点击日期快速跳转并查看该日日记
- **时间轴浏览**：按时间顺序浏览所有日记
- **Markdown 编辑器**：支持富文本格式的日记内容编辑
- **多视图模式**：日历视图、标签视图、相册视图三种模式

### 🏷️ 智能标签系统
- **多标签分类**：为日记添加多个标签进行分类
- **标签组管理**：支持按组管理标签（最近使用、地点、活动等）
- **标签筛选**：支持多标签组合筛选（AND 逻辑）
- **最近使用**：自动记录最近使用的标签（LRU 算法）
- **标签颜色**：基于 hashCode 自动生成标签颜色

### 📷 图片相册功能
- **图片集中展示**：集中展示所有日记中的图片
- **缩略图浏览**：3 列网格布局展示图片缩略图
- **全屏查看**：支持图片全屏查看和缩放（PhotoView）
- **Hero 动画**：流畅的页面转场动画效果
- **图片关联**：可从图片跳转到对应的日记条目
- **双重存储**：支持 imageUrls 数组和 Markdown 内嵌图片

### 📝 附加信息记录
- **位置记录**：记录日记的拍摄或书写地点
- **心情记录**：通过表情符号记录当时心情
- **天气记录**：记录当天的天气状况
- **创建时间**：可自定义日记的创建时间
- **字数统计**：自动统计日记字数

## 界面结构

### 主界面（MainScreen）
底部导航栏切换三个视图：
- **📅 日历视图**（CalendarScreen）：日历 + 日记列表
- **🏷️ 标签视图**（TagScreen）：标签筛选 + 日记列表
- **📷 相册视图**（AlbumScreen）：图片网格展示

### 日历视图（CalendarScreen）
```
┌─────────────────────────────────────┐
│ 📓 日历日记              [回到今天]  │
├─────────────────────────────────────┤
│                                     │
│         日历组件（TableCalendar）      │
│      📅 15    📅 16    📅 17        │
│     [2]📅 18   📅 19   [1]📅 20     │
│                                     │
├─────────────────────────────────────┤
│ 📝 2025-01-18 的日记                 │
│ ┌─────────────────────────────────┐ │
│ │ 美好的一天                      │ │
│ │ # 今日游记                      │ │
│ │ 今天天气很好...                 │ │
│ │ [🏷️ 生活] [🏷️ 旅行] [😊] [☀️]     │ │
│ └─────────────────────────────────┘ │
│ ┌─────────────────────────────────┐ │
│ │ 晚餐聚会                        │ │
│ │ 和朋友聚餐...                   │ │
│ │ [🏷️ 聚会] [😊]                  │ │
│ └─────────────────────────────────┘ │
├─────────────────────────────────────┤
│            [＋ 新建日记]              │
└─────────────────────────────────────┘
```

### 标签视图（TagScreen）
```
┌─────────────────────────────────────┐
│ 🏷️ 标签管理              [管理]      │
├─────────────────────────────────────┤
│ [生活] [工作] [旅行] [聚会] [心情]    │
├─────────────────────────────────────┤
│ 📝 标签"生活"下的日记                │
│ ┌─────────────────────────────────┐ │
│ │ 美好的一天                      │ │
│ │ [🏷️ 生活] [🏷️ 心情]             │ │
│ └─────────────────────────────────┘ │
│ ┌─────────────────────────────────┐ │
│ │ 周末闲逛                        │ │
│ │ [🏷️ 生活] [🏷️ 休闲]             │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

### 相册视图（AlbumScreen）
```
┌─────────────────────────────────────┐
│ 📷 所有照片                         │
├─────────────────────────────────────┤
│ ┌───┐ ┌───┐ ┌───┐ ┌───┐           │
│ │🖼️ │ │🖼️ │ │🖼️ │ │🖼️ │           │
│ └───┘ └───┘ └───┘ └───┘           │
│ ┌───┐ ┌───┐ ┌───┐ ┌───┐           │
│ │🖼️ │ │🖼️ │ │🖼️ │ │🖼️ │           │
│ └───┘ └───┘ └───┘ └───┘           │
│ ┌───┐ ┌───┐ ┌───┐ ┌───┐           │
│ │🖼️ │ │🖼️ │ │🖼️ │ │🖼️ │           │
│ └───┘ └───┘ └───┘ └───┘           │
└─────────────────────────────────────┘
```

## 数据模型

### CalendarEntry（日记条目）
```dart
{
  "id": "1737004800000",              // 唯一标识符（时间戳）
  "title": "美好的一天",              // 标题
  "content": "# 美好的一天\n\n今天...",  // 内容（Markdown 格式）
  "createdAt": "2025-01-15T08:30:00.000Z",  // 创建时间
  "updatedAt": "2025-01-15T20:15:00.000Z",  // 更新时间
  "tags": ["生活", "心情"],           // 标签列表
  "location": "家",                   // 位置
  "mood": "😊",                      // 心情（表情）
  "weather": "晴天",                  // 天气
  "imageUrls": ["images/photo1.jpg"]  // 图片URL列表
}
```

### 存储结构
```
calendar_album/
├── calendar_entries           # 日记条目数据（JSON Map）
└── data/
    ├── calendar_tag_groups.json    # 标签组数据
    └── calendar_recent_tags.json   # 最近使用的标签
```

## 核心 API

### 统计接口
```dart
// 获取今日日记数
int getTodayEntriesCount();

// 获取最近7天的日记数
int getLast7DaysEntriesCount();

// 获取所有日记数
int getAllEntriesCount();

// 获取标签数量
int getTagsCount();
```

### CalendarController 控制器方法
```dart
// 日期选择与导航
void selectDate(DateTime date);           // 选择日期
set currentMonth(DateTime month);         // 设置当前月份
bool loadMoreMonths(bool isBefore);       // 加载更多月份

// 日记管理
List<CalendarEntry> getEntriesForDate(DateTime date);  // 获取指定日期的日记
Future<void> addEntry(CalendarEntry entry);            // 添加日记
Future<void> updateEntry(CalendarEntry entry);         // 更新日记
Future<void> deleteEntry(CalendarEntry entry);         // 删除日记
CalendarEntry? getEntryById(String id);                // 根据ID获取日记

// 标签与图片相关
List<String> getAllTags();                             // 获取所有标签
List<CalendarEntry> getEntriesByTag(String tag);       // 根据标签获取日记
List<CalendarEntry> getEntriesByTags(List<String> tags);  // 根据多标签获取日记
List<String> getAllImages();                           // 获取所有图片URL
CalendarEntry? getDiaryEntryForImage(String imageUrl); // 根据图片URL获取日记
```

### TagController 控制器方法
```dart
// 标签管理
List<String> get tags;                                 // 获取所有标签
Future<void> addTag(String tag, {String? groupName});  // 添加标签
Future<void> deleteTag(String tag);                    // 删除标签
bool hasTag(String name);                              // 检查标签是否存在

// 最近使用标签
Future<void> updateRecentTags(List<String> tags);      // 更新最近使用的标签

// UI交互
Future<List<String>?> showTagManagerDialog(BuildContext context);  // 显示标签管理对话框
```

## 使用场景

### 个人日记
- **生活记录**：记录日常生活点滴
- **心情记录**：通过表情记录心情变化
- **天气关联**：记录天气对心情的影响
- **地点标记**：记录在不同地点的经历

### 旅行游记
- **行程记录**：按日期记录旅行行程
- **照片整理**：集中管理旅行照片
- **地点标签**：按地点分类整理
- **Markdown 游记**：支持富文本游记编写

### 工作日志
- **项目记录**：按项目或任务分类
- **会议记录**：记录会议要点
- **工作笔记**：配合图片的工作笔记
- **标签管理**：按工作类型分类

### 学习笔记
- **学习日记**：记录学习过程
- **知识点标签**：按学科或主题分类
- **资料整理**：关联学习资料图片
- **进度追踪**：通过标签追踪学习进度

## 关键特性

### 1. 日期标准化
为避免时区问题，所有日期都进行标准化处理：
```dart
DateTime normalizeDate(DateTime date) {
  return DateTime(date.year, date.month, date.day);
}
```

### 2. 日历范围动态加载
支持动态加载更多月份，避免一次性加载所有数据：
- 初始加载当前月份
- 用户滚动到边界时自动加载3个月
- 支持展开/收起（1个月 ↔ 7个月）

### 3. 标签组管理
使用标签组组织标签：
- "最近使用"组自动更新（LRU算法）
- 支持自定义标签组
- 标签可属于多个组

### 4. 图片提取逻辑
支持两种方式存储图片：
- imageUrls 数组（直接存储）
- Markdown 内容中的图片（正则提取）

### 5. 多标签筛选（AND逻辑）
使用 `every()` 确保所有标签都匹配，按创建时间倒序排列

### 6. TableCalendar 自定义单元格
- 选中日期高亮显示
- 有日记的日期显示数量徽章
- 区分当前月份和其他月份的日期颜色

## 编辑器功能

### EntryEditorScreen
采用 Controller + UI 分离架构：
```
entry_editor_screen.dart
├── entry_editor_controller.dart    # 控制器（状态管理）
├── entry_editor_ui.dart            # UI层（布局渲染）
├── entry_editor_image_handler.dart # 图片处理Mixin
└── entry_editor_tag_handler.dart   # 标签处理Mixin
```

支持功能：
- Markdown 格式编辑
- 标题和内容分离
- 标签选择（支持标签管理对话框）
- 图片上传和管理
- 位置/心情/天气选择
- 创建时间选择

## 主页卡片

插件在主页提供卡片视图：
```
┌─────────────────────────────┐
│ 📓 日历相册                │
├─────────────────────────────┤
│  今日日记    │   七日日记   │
│      2      │       8       │
├─────────────────────────────┤
│  所有日记    │   标签数量   │
│     156     │      12       │
└─────────────────────────────┘
```

## 国际化支持

### 支持语言
- 简体中文 (zh)
- 英语 (en)

### 关键字符串
- 插件名称、日历、标签、相册
- 统计相关：今日日记、七日日记、所有日记、标签数量
- 操作相关：新建条目、编辑条目、删除条目
- 内容相关：标题、内容、位置、心情、天气

## 外部依赖

- `table_calendar`: 日历组件
- `photo_view`: 图片查看器
- `intl`: 日期格式化
- `provider`: 状态管理

## 常见问题

### Q: 如何添加新的心情/天气选项？
在 `EntryEditorController` 中修改对应的列表：
```dart
final List<String> moods = ['😊', '😢', '😡', '😴', '🤔', '😎', '😍'];
final List<String> weathers = ['晴天', '多云', '雨天', '雪天'];
```

### Q: 如何修改日记存储格式？
当前使用 JSON 格式存储，以日期为key的Map结构，修改 `CalendarController._saveEntries()` 和 `_loadEntries()` 方法。

### Q: 如何实现标签的AND/OR逻辑切换？
当前使用AND逻辑（所有标签都匹配），可添加新的OR逻辑方法。

### Q: 如何优化图片加载性能？
建议使用 `CachedNetworkImage` 包缓存网络图片，生成缩略图，使用分页加载。

### Q: 如何导出日记数据？
当前未实现导出功能，建议添加 `exportToMarkdown()` 方法导出为 Markdown 格式。

### Q: 标签组的"最近使用"是如何实现的？
使用LRU（最近最少使用）算法，最多保持10个最近使用的标签。

---

*用文字和图片记录每一个珍贵瞬间*
