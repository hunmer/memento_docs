# Store - 积分商店插件

<PluginSwiper plugin-name="store" />

🏪 **Store 积分商店** - 通过应用内行为自动获得积分奖励，使用积分兑换虚拟商品

## 核心功能

### 💎 积分系统
- **自动积分奖励**：通过应用内行为自动获得积分
  - 添加活动记录：+3积分
  - 完成签到：+10积分
  - 完成任务：+20积分
  - 添加笔记：+10积分
  - 添加物品：+5积分
  - 发送消息：+1积分
  - 添加记录：+2积分
  - 添加日记：+5积分
  - 添加账单：+10积分

- **积分历史记录**：完整的积分获得和消耗日志
- **自定义配置**：可动态修改各事件的积分值

### 🎁 商品管理
- **添加商品**：支持添加虚拟商品（免作业卡、优惠券等）
- **商品信息**：
  - 商品名称和描述
  - 商品图片（本地或网络）
  - 库存数量管理
  - 积分价格设置
  - 兑换时间范围
  - 使用期限（天数）
- **商品归档**：支持归档和恢复商品，保留历史数据
- **商品排序**：按库存、价格、过期时间排序

### 📦 物品兑换与使用
- **积分兑换**：使用积分兑换商品，扣除积分并减少库存
- **商品快照**：兑换时保存商品完整信息，防止商品修改后信息丢失
- **使用物品**：记录物品使用次数和过期状态
- **使用历史**：完整的物品使用历史记录
- **过期管理**：自动检测和处理过期物品

### 📊 数据统计
- **实时统计**：
  - 商品总数
  - 用户物品总数
  - 当前积分余额
  - 七天内到期物品数量
- **流式更新**：数据变化实时反映在界面上
- **徽章显示**：主页卡片展示关键统计数据

## 界面结构

### 三页式设计
1. **商品列表页**：浏览和兑换可用商品
2. **我的物品页**：查看已兑换的物品和使用状态
3. **积分历史页**：查看所有积分获得和消耗记录

### 主页卡片视图
```
┌─────────────────────────────┐
│ 🛍️ 物品兑换                │
├─────────────────────────────┤
│  商品数量    │   物品数量   │
│      5       │      3       │
├─────────────────────────────┤
│  我的积分    │  七天到期    │
│     150      │      2       │
└─────────────────────────────┘
```

## 事件集成

Store 插件通过事件系统监听应用内其他插件的行为，自动发放积分：

| 事件名称 | 来源插件 | 积分奖励 | 触发条件 |
|---------|---------|---------|---------|
| activity_added | activity | +3 | 添加活动记录 |
| checkin_completed | checkin | +10 | 完成签到 |
| task_completed | todo | +20 | 完成任务 |
| note_added | notes | +10 | 添加笔记 |
| goods_item_added | goods | +5 | 添加物品 |
| onMessageSent | chat | +1 | 发送消息 |
| onRecordAdded | tracker | +2 | 添加记录 |
| diary_entry_created | diary | +5 | 添加日记 |
| bill_added | bill | +10 | 添加账单 |

**事件流程**：
```
其他插件触发事件 → EventManager广播 → PointAwardEvent监听 → 自动发放积分 → 记录积分历史
```

## 操作指南

### 积分自动获取
1. **使用应用功能**：正常使用其他插件功能即可自动获得积分
2. **查看积分**：在主页卡片或积分历史页面查看当前积分
3. **查看记录**：在积分历史页面查看详细的获得/消耗记录
4. **修改配置**：在设置中修改各事件的积分值

### 兑换商品
1. 进入 Store 插件主界面
2. 切换到"商品列表"页面
3. 浏览可兑换商品
4. 点击商品查看详情和兑换条件
5. 确认积分足够后点击兑换
6. 系统自动扣除积分并生成用户物品
7. 在"我的物品"页面查看已兑换的物品

### 管理商品
1. 在商品列表页点击添加按钮
2. 填写商品信息：
   - 商品名称和描述
   - 上传商品图片
   - 设置积分价格
   - 设置库存数量
   - 设置兑换时间范围
   - 设置使用期限（天数）
3. 保存商品信息
4. 商品将出现在商品列表中
5. 可对商品进行归档/恢复操作

### 使用物品
1. 进入"我的物品"页面
2. 查看已兑换的物品
3. 点击物品查看使用状态和过期时间
4. 点击"使用"按钮使用物品
5. 系统记录使用历史
6. 使用次数归零后物品自动移除

## 高级功能

### 商品快照机制
- **防止信息丢失**：兑换时保存商品的完整信息（名称、图片、价格、描述等）
- **历史记录**：即使商品被修改或删除，用户物品信息依然完整
- **数据一致性**：确保用户物品显示的是购买时的信息

### 归档管理
- **软删除**：商品归档而非删除，保留历史数据
- **数据恢复**：支持从归档中恢复商品
- **库存管理**：自动处理库存为0的商品

### 过期处理
- **自动检测**：自动检测物品是否过期
- **到期提醒**：主页卡片显示7天内到期的物品数量
- **过期处理**：过期物品无法使用，自动标记并可清理

### 数据持久化
- **独立存储**：每类数据独立存储文件
  - products.json：商品列表
  - archived_products.json：存档商品
  - points.json：积分余额和日志
  - user_items.json：用户物品
  - used_items.json：已使用物品
- **实时同步**：所有操作立即保存到本地存储
- **流式更新**：使用 Stream 实现数据变化实时通知UI

## 技术特点

### 事件驱动架构
- **解耦设计**：通过事件系统实现插件间通信
- **单向依赖**：Store 监听其他插件事件，其他插件不感知 Store
- **可扩展性**：可轻松添加新的积分奖励事件

### Controller 模式
- **业务逻辑集中**：StoreController 负责所有核心业务逻辑
- **职责分离**：UI层与业务逻辑层分离
- **流式数据**：使用 Stream 实现响应式数据更新

### 数据模型设计
- **Product**：商品模型，支持完整商品信息
- **UserItem**：用户物品模型，包含商品快照和使用状态
- **PointsLog**：积分记录模型，完整的积分变化历史
- **UsedItem**：已使用物品模型，记录使用历史

## 最佳实践

### 积分设置建议
- **渐进式奖励**：设置不同难度行为的积分差异（如签到10分，任务20分）
- **平衡激励**：确保积分获取不会过于容易或困难
- **自定义配置**：根据使用场景调整积分值

### 商品管理建议
- **明确商品定位**：虚拟商品适合学习、工作、生活场景（如免作业卡、学习券等）
- **合理定价**：根据商品价值设置合适的积分价格
- **库存管理**：及时补充热门商品库存
- **商品归档**：将不再提供的商品归档而非删除

### 数据安全建议
- **定期备份**：Store 数据存储在本地，建议定期备份
- **商品快照**：依赖商品快照机制保护用户权益
- **积分日志**：保留完整的积分历史记录供查询

## 常见问题

**Q: 积分会过期吗？**
A: 积分本身不会过期，但兑换的物品有使用期限，过期后无法使用。

**Q: 为什么需要商品快照？**
A: 商品快照保存兑换时的完整商品信息，防止商品修改后用户物品信息丢失。例如：用户用50积分兑换"免作业卡"，后来价格改为100积分，用户物品仍显示购买价格50积分。

**Q: 如何添加新的积分奖励事件？**
A: 需要在 StorePlugin.defaultPointSettings 中添加配置，订阅对应事件，并在 PointAwardEvent 中添加处理方法。具体实现可参考技术文档。

**Q: 可以删除积分记录吗？**
A: 当前实现不支持删除积分记录，但可以清空积分历史。建议谨慎操作。

**Q: 物品使用次数归零后怎么办？**
A: 使用次数归零后，物品会自动从"我的物品"列表中移除，但使用历史会保留在"已使用物品"中。

**Q: 如何防止用户刷积分？**
A: 当前实现对事件频率无限制，建议添加冷却时间机制（如同一事件10秒内只能奖励一次）。

**Q: 商品库存为0后如何处理？**
A: 当前实现：库存为0时仍显示在商品列表，但无法兑换。建议定期管理库存或自动归档售罄商品。

**Q: 支持数据导出吗？**
A: 当前未实现导出功能，积分历史、商品信息等数据仅支持本地存储查看。

---

*让每一份努力都有回报，让每一次进步都被记录*