### 完整指南：使用Flutter插件包 + home_widget实现两个Android小组件的XML注册、方法包装，并暴露实例给主App

本指南基于Flutter官方文档（开发插件包的步骤）、home_widget包的API参考（从pub.dev获取，包括数据保存、widget更新和交互回调）、以及Android多小组件注册的最佳实践（例如Stack Overflow和GitHub讨论）。指南假设你使用Flutter 3.x+版本，针对Android平台（iOS类似但需WidgetKit扩展）。我们将创建一个名为`memento_widgets`的插件包，实现两个小组件（例如，一个简单文本widget和一个图像widget），包装home_widget的方法（如init、saveData、updateWidget），并通过单例实例暴露给安装插件的主App。测试将在插件的`example/`目录中进行。

#### 步骤1: 创建插件包
1. **使用命令创建插件包**：
   - 打开终端，运行以下命令创建支持Android和iOS的插件包（但本指南聚焦Android）：
     ```
     flutter create --template=plugin --platforms=android,ios --org com.example memento_widgets
     ```
   - 这会生成项目结构：
     - `lib/memento_widgets.dart`：Dart API文件。
     - `android/`：Android原生代码（Kotlin/Java）。
     - `ios/`：iOS原生代码（Swift/Objective-C）。
     - `example/`：一个测试Flutter App，自动依赖插件。
     - `pubspec.yaml`：包元数据。

2. **添加home_widget依赖**：
   - 在插件根目录的`pubspec.yaml`中添加：
     ```yaml
     dependencies:
       flutter:
         sdk: flutter
       home_widget: ^0.6.0  # 检查pub.dev获取最新版本
     ```
   - 对于Android平台依赖，在`android/build.gradle`中添加（如果home_widget需要额外配置，但通常自动处理）：
     ```groovy
     dependencies {
       implementation "dev.fluttercommunity.plus:home-widget:0.6.0"  # 如需手动
     }
     ```
   - 运行`flutter pub get`安装依赖。

#### 步骤2: 编写核心代码
核心包括：
- **Android侧**：注册两个小组件的XML布局和Provider（使用home_widget的桥接）。
- **Dart侧**：包装home_widget方法，并通过单例实例暴露API。

##### 2.1 Android侧：实现两个小组件的XML注册
home_widget不直接处理XML注册；你需要在Android原生代码中手动定义布局、Provider和Manifest注册。每个小组件需要独立的XML和<receiver>条目，即使共享Provider类（通过不同name区分）。

1. **创建XML布局**（在`android/src/main/res/layout/`）：
   - 对于第一个小组件（e.g., TextWidget）: 创建`text_widget_layout.xml`：

     详情请参考 Android 开发文档中的 App Widget 布局创建方法。
   - 对于第二个小组件（e.g., ImageWidget）: 创建`image_widget_layout.xml`：

     详情请参考 Android 开发文档中的 App Widget 布局创建方法。

2. **创建AppWidgetProvider类**（在`android/src/main/kotlin/com/example/memento_widgets/`）：
   - 你可以为两个widget共享一个Provider类（通过context区分），或创建两个。示例使用共享：
     ```kotlin
     package github.hunmer.memento_widgets

     import android.appwidget.AppWidgetManager
     import android.appwidget.AppWidgetProvider
     import android.content.Context
     import android.widget.RemoteViews
     import io.flutter.plugins.homewidget.HomeWidgetPlugin  // home_widget的桥接

     class MyWidgetProvider : AppWidgetProvider() {
         override fun onUpdate(context: Context, appWidgetManager: AppWidgetManager, appWidgetIds: IntArray) {
             for (appWidgetId in appWidgetIds) {
                 // 使用home_widget插件从SharedPreferences读取数据
                 val data = HomeWidgetPlugin.getData(context)
                 val views = if (/* 检查widget类型，根据meta-data或ID */) {
                     RemoteViews(context.packageName, R.layout.text_widget_layout).apply {
                         setTextViewText(R.id.widget_text, data.getString("text_key", "默认"))
                     }
                 } else {
                     RemoteViews(context.packageName, R.layout.image_widget_layout).apply {
                         // 设置图像，从数据加载（假设渲染图像路径）
                         setImageViewUri(R.id.widget_image, Uri.parse(data.getString("image_key", "")))
                     }
                 }
                 appWidgetManager.updateAppWidget(appWidgetId, views)
             }
         }
     }
     ```

3. **注册小组件在AndroidManifest.xml**（在`android/src/main/`）：
   - 添加两个<receiver>条目，每个指向同一个Provider但不同name和meta-data（指向不同XML）：
     ```xml
     <manifest ...>
         <application ...>
             <receiver android:name=".MyWidgetProvider" android:exported="false">
                 <intent-filter>
                     <action android:name="android.appwidget.action.APPWIDGET_UPDATE" />
                 </intent-filter>
                 <meta-data
                     android:name="android.appwidget.provider"
                     android:resource="@xml/text_widget_info" />  <!-- 第一个widget -->
             </receiver>
             <receiver android:name=".MyWidgetProvider" android:exported="false">
                 <intent-filter>
                     <action android:name="android.appwidget.action.APPWIDGET_UPDATE" />
                 </intent-filter>
                 <meta-data
                     android:name="android.appwidget.provider"
                     android:resource="@xml/image_widget_info" />  <!-- 第二个widget -->
             </receiver>
         </application>
     </manifest>
     ```
   - 创建widget info XML（在`android/src/main/res/xml/`）：
     - `text_widget_info.xml`：
       ```xml
       <?xml version="1.0" encoding="utf-8"?>
       <appwidget-provider xmlns:android="http://schemas.android.com/apk/res/android">
           <initialLayout>@layout/text_widget_layout</initialLayout>
           <minWidth>250dp</minWidth>
           <minHeight>110dp</minHeight>
           <updatePeriodMillis>1800000</updatePeriodMillis>  <!-- 每30分钟更新 -->
       </appwidget-provider>
       ```
     - `image_widget_info.xml`：类似，但调整大小和布局。

##### 2.2 Dart侧：包装home_widget方法并暴露单例实例
在`lib/memento_widgets.dart`中，创建一个单例类`MyWidgetManager`，包装home_widget的API（如init、saveWidgetData、updateWidget、renderFlutterWidget）。单例确保全局唯一实例。

```dart
import 'package:home_widget/home_widget.dart';
import 'package:flutter/material.dart';  // 如需渲染widget

class MyWidgetManager {
  // 单例模式
  static MyWidgetManager? _instance;
  factory MyWidgetManager() => _instance ??= MyWidgetManager._internal();
  MyWidgetManager._internal();

  // 包装init（对于iOS App Group，但Android可选）
  Future<void> init(String? appGroupId) async {
    if (appGroupId != null) {
      await HomeWidget.setAppGroupId(appGroupId);
    }
    // 可添加其他初始化，如注册背景任务
  }

  // 包装保存数据（共享给两个widget）
  Future<void> saveData(String key, dynamic value) async {
    if (value is String) {
      await HomeWidget.saveWidgetData<String>(key, value);
    } // 添加其他类型支持
  }

  // 包装更新widget（广播到所有实例，支持指定name区分两个widget）
  Future<void> updateWidget(String widgetName) async {
    await HomeWidget.updateWidget(name: widgetName);  // e.g., 'TextWidget' or 'ImageWidget'
  }

  // 包装渲染Flutter UI为图像（用于ImageWidget）
  Future<void> renderFlutterUI(Widget flutterWidget, String key, Size size) async {
    await HomeWidget.renderFlutterWidget(flutterWidget, logicalSize: size, key: key);
  }

  // 示例：注册交互回调（包装为可选）
  void registerInteractivityCallback(Function(Uri?) callback) {
    HomeWidget.registerInteractivityCallback(callback);
  }
}
```

- **暴露实例**：主App通过`MyWidgetManager()`获取单例，无需new。

#### 步骤3: 编写测试页面
插件的`example/`目录是一个完整的Flutter App，用于测试。

1. **修改example/pubspec.yaml**：
   - 它已自动依赖`memento_widgets: path: ../`。

2. **编写测试页面**（在`example/lib/main.dart`）：
   ```dart
   import 'package:flutter/material.dart';
   import 'package:memento_widgets/memento_widgets.dart';

   void main() async {
     WidgetsFlutterBinding.ensureInitialized();
     final manager = MyWidgetManager();  // 获取单例实例
     await manager.init('group.com.example');  // 如需iOS
     runApp(MyApp(manager: manager));
   }

   class MyApp extends StatelessWidget {
     final MyWidgetManager manager;
     const MyApp({super.key, required this.manager});

     @override
     Widget build(BuildContext context) {
       return MaterialApp(
         home: Scaffold(
           appBar: AppBar(title: const Text('Widget Plugin Test')),
           body: Center(
             child: Column(
               mainAxisAlignment: MainAxisAlignment.center,
               children: [
                 ElevatedButton(
                   onPressed: () async {
                     await manager.saveData('text_key', '新文本');
                     await manager.updateWidget('TextWidget');  // 更新第一个widget
                   },
                   child: const Text('更新文本Widget'),
                 ),
                 ElevatedButton(
                   onPressed: () async {
                     await manager.renderFlutterUI(
                       Container(color: Colors.blue, child: const Text('图像UI')),
                       'image_key',
                       const Size(200, 200),
                     );
                     await manager.updateWidget('ImageWidget');  // 更新第二个widget
                   },
                   child: const Text('更新图像Widget'),
                 ),
               ],
             ),
           ),
         ),
       );
     }
   }
   ```

3. **测试**：
   - 从`example/`运行`flutter run -d android`。
   - 安装App后，在Android桌面添加两个小组件（搜索你的App）。
   - 点击按钮测试更新（数据通过home_widget共享，原生Provider读取并刷新）。

#### 注意事项
- **多个Widget区分**：在updateWidget中使用不同name（匹配Manifest的receiver name）。
- **背景更新**：集成`workmanager`包以支持后台刷新（在单例中添加方法）。
